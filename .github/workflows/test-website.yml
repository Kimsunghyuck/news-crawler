name: Test Website

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/test-website.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install beautifulsoup4 lxml
    
    - name: Check HTML files exist
      run: |
        echo "Checking required files..."
        test -f docs/index.html || exit 1
        test -d docs/static || exit 1
        test -d docs/data || exit 1
        echo "‚úÖ All required files exist"
    
    - name: Validate HTML structure
      run: |
        echo "Validating HTML structure..."
        python3 << 'EOF'
        from bs4 import BeautifulSoup
        import sys
        
        with open('docs/index.html', 'r', encoding='utf-8') as f:
            html = f.read()
        
        soup = BeautifulSoup(html, 'html.parser')
        
        # ÌïÑÏàò ÏöîÏÜå Ï≤¥ÌÅ¨
        errors = []
        
        if not soup.find('nav', class_='main-navigation'):
            errors.append("‚ùå Navigation not found")
        else:
            print("‚úÖ Navigation found")
        
        if not soup.find('section', class_='news-section'):
            errors.append("‚ùå News section not found")
        else:
            print("‚úÖ News section found")
        
        if not soup.find('footer', class_='site-footer'):
            errors.append("‚ùå Footer not found")
        else:
            print("‚úÖ Footer found")
        
        # Ïπ¥ÌÖåÍ≥†Î¶¨ Î©îÎâ¥ Ï≤¥ÌÅ¨
        categories = soup.find_all('li', class_='category-item')
        if len(categories) < 3:
            errors.append(f"‚ùå Expected at least 3 categories, found {len(categories)}")
        else:
            print(f"‚úÖ Found {len(categories)} categories")
        
        # JavaScript ÌååÏùº Ï≤¥ÌÅ¨
        if not soup.find('script', src='static/js/main.js'):
            errors.append("‚ùå main.js not found")
        else:
            print("‚úÖ main.js linked")
        
        # CSS ÌååÏùº Ï≤¥ÌÅ¨
        if not soup.find('link', href='static/css/style.css'):
            errors.append("‚ùå style.css not found")
        else:
            print("‚úÖ style.css linked")
        
        if errors:
            print("\n".join(errors))
            sys.exit(1)
        
        print("\n‚úÖ HTML structure validation passed!")
        EOF
    
    - name: Check JavaScript syntax
      run: |
        echo "Checking JavaScript syntax..."
        python3 << 'EOF'
        import re
        import sys
        
        with open('docs/static/js/main.js', 'r', encoding='utf-8') as f:
            js_content = f.read()
        
        errors = []
        
        # ÌïÑÏàò Ìï®Ïàò Ï≤¥ÌÅ¨
        required_functions = [
            'loadNews',
            'initNavigation',
            'renderNewsGrid',
            'updateSourceTitle',
            'initTrendPanel',
            'loadStatisticsData',
            'collectDailyStats',
            'renderCategoryPieChart'
        ]
        
        for func in required_functions:
            if f'function {func}' not in js_content and f'{func} =' not in js_content:
                errors.append(f"‚ùå Function '{func}' not found")
            else:
                print(f"‚úÖ Function '{func}' found")
        
        # fetch ÏÇ¨Ïö© ÌôïÏù∏ (JSON Î°úÎìú)
        if 'fetch(' not in js_content:
            errors.append("‚ùå fetch() not found - JSON loading may not work")
        else:
            print("‚úÖ fetch() found")
        
        if errors:
            print("\n".join(errors))
            sys.exit(1)
        
        print("\n‚úÖ JavaScript validation passed!")
        EOF
    
    - name: Check CSS files exist
      run: |
        echo "Checking CSS files..."
        test -f docs/static/css/style.css || exit 1
        echo "‚úÖ CSS files exist"
    
    - name: Check image files exist
      run: |
        echo "Checking image files..."
        test -f docs/static/images/mainIcon.png || exit 1
        test -f docs/static/images/donga.png || exit 1
        test -f docs/static/images/chosun.png || exit 1
        test -f docs/static/images/joongang.png || exit 1
        test -f docs/static/images/favicon.ico || exit 1
        test -f docs/static/images/no-image.png || exit 1
        echo "‚úÖ All required images exist"
    
    - name: Validate JSON data structure
      run: |
        echo "Validating JSON data structure..."
        python3 << 'EOF'
        import json
        import os
        import sys
        from pathlib import Path
        
        errors = []
        valid_files = 0
        
        data_dir = Path('docs/data')
        
        if not data_dir.exists():
            print("‚ö†Ô∏è No data directory found")
            sys.exit(0)
        
        for json_file in data_dir.rglob('*.json'):
            try:
                with open(json_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                
                # Ìä∏Î†åÎìú ÌååÏùºÏùÄ Í∞ùÏ≤¥ ÌòïÌÉú, Îâ¥Ïä§ ÌååÏùºÏùÄ Î¶¨Ïä§Ìä∏ ÌòïÌÉú
                if 'trends' in str(json_file):
                    # Ìä∏Î†åÎìú ÌååÏùº Í≤ÄÏ¶ù
                    if not isinstance(data, dict):
                        errors.append(f"‚ùå {json_file}: Not a dictionary")
                        continue
                    
                    required_fields = ['date', 'generated_at', 'daily_top_keywords', 'category_keywords']
                    missing = [f for f in required_fields if f not in data]
                    if missing:
                        errors.append(f"‚ùå {json_file}: Missing fields {missing}")
                    else:
                        valid_files += 1
                        keyword_count = len(data.get('daily_top_keywords', []))
                        print(f"‚úÖ {json_file.relative_to(data_dir)}: Valid ({keyword_count} keywords)")
                else:
                    # Îâ¥Ïä§ ÌååÏùº Í≤ÄÏ¶ù
                    if not isinstance(data, list):
                        errors.append(f"‚ùå {json_file}: Not a list")
                        continue
                    
                    if len(data) == 0:
                        print(f"‚ö†Ô∏è {json_file}: Empty file")
                        continue
                    
                    # Ï≤´ Î≤àÏß∏ Ìï≠Î™© Í≤ÄÏ¶ù
                    item = data[0]
                    required_fields = ['title', 'url', 'date', 'category', 'source', 'image_url']
                    
                    missing = [f for f in required_fields if f not in item]
                    if missing:
                        errors.append(f"‚ùå {json_file}: Missing fields {missing}")
                    else:
                        valid_files += 1
                        print(f"‚úÖ {json_file.relative_to(data_dir)}: Valid ({len(data)} items)")
            
            except json.JSONDecodeError as e:
                errors.append(f"‚ùå {json_file}: Invalid JSON - {e}")
            except Exception as e:
                errors.append(f"‚ùå {json_file}: Error - {e}")
        
        if errors:
            print("\n".join(errors))
            sys.exit(1)
        
        print(f"\n‚úÖ All {valid_files} JSON files are valid!")
        EOF
    
    - name: Start HTTP server
      run: |
        cd docs
        python3 -m http.server 8000 &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        sleep 3
        echo "‚úÖ HTTP server started on port 8000"
    
    - name: Test HTTP endpoints
      run: |
        echo "Testing HTTP endpoints..."
        
        # Test index.html
        if curl -f -s http://localhost:8000/ > /dev/null; then
            echo "‚úÖ index.html accessible"
        else
            echo "‚ùå index.html not accessible"
            exit 1
        fi
        
        # Test CSS
        if curl -f -s http://localhost:8000/static/css/style.css > /dev/null; then
            echo "‚úÖ style.css accessible"
        else
            echo "‚ùå style.css not accessible"
            exit 1
        fi
        
        # Test JavaScript
        if curl -f -s http://localhost:8000/static/js/main.js > /dev/null; then
            echo "‚úÖ main.js accessible"
        else
            echo "‚ùå main.js not accessible"
            exit 1
        fi
        
        echo "‚úÖ All HTTP endpoints working!"
    
    - name: Check for broken links
      run: |
        echo "Checking for broken internal links..."
        python3 << 'EOF'
        from bs4 import BeautifulSoup
        from pathlib import Path
        
        with open('docs/index.html', 'r', encoding='utf-8') as f:
            soup = BeautifulSoup(f.read(), 'html.parser')
        
        errors = []
        checked = 0
        checked_paths = set()
        
        # Î™®Îì† Î°úÏª¨ ÎßÅÌÅ¨ ÏàòÏßë Î∞è Ï≤¥ÌÅ¨
        for tag in soup.find_all(['link', 'script', 'img']):
            path = tag.get('src') or tag.get('href')
            if path and not path.startswith(('http://', 'https://', '//', '#', 'data:')):
                # Remove query parameters and fragments
                path = path.split('?')[0].split('#')[0]
                
                # Ï§ëÎ≥µ Ï≤¥ÌÅ¨ Î∞©ÏßÄ
                if path in checked_paths:
                    continue
                checked_paths.add(path)
                
                file_path = Path('docs') / path
                if not file_path.exists():
                    errors.append(f"‚ùå Missing: {path}")
                else:
                    checked += 1
        
        if errors:
            print("\n".join(errors))
            exit(1)
        
        print(f"‚úÖ All {checked} internal links are valid!")
        EOF
    
    # ============================================
    # Playwright E2E Tests
    # ============================================
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Playwright
      run: |
        npm init -y
        npm install -D @playwright/test
        npx playwright install chromium --with-deps
    
    - name: Create Playwright test
      run: |
        cat > e2e-test.spec.ts << 'EOF'
        import { test, expect } from '@playwright/test';
        
        test.describe('ÏõπÏÇ¨Ïù¥Ìä∏ E2E ÌÖåÏä§Ìä∏', () => {
          test.beforeEach(async ({ page }) => {
            await page.goto('http://localhost:8000/');
            await page.waitForLoadState('networkidle');
          });
        
          test('Î©îÏù∏ ÌéòÏù¥ÏßÄ Î°úÎìú', async ({ page }) => {
            await expect(page.locator('nav.main-navigation')).toBeVisible();
            await expect(page.locator('#home-dashboard')).toBeVisible();
            await expect(page.locator('footer.site-footer')).toBeVisible();
            console.log('‚úÖ Î©îÏù∏ ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å (Ìôà ÎåÄÏãúÎ≥¥Îìú)');
          });
        
          test('Ìä∏Î†åÎìú Î≤ÑÌäº Ï°¥Ïû¨', async ({ page }) => {
            const trendBtn = page.locator('#trend-btn');
            await expect(trendBtn).toBeVisible();
            console.log('‚úÖ Ìä∏Î†åÎìú Î≤ÑÌäº ÌôïÏù∏');
          });
        
          test('Ïπ¥ÌÖåÍ≥†Î¶¨ Î©îÎâ¥ ÌÅ¥Î¶≠', async ({ page }) => {
            const categories = page.locator('li.category-item');
            const count = await categories.count();
            expect(count).toBeGreaterThanOrEqual(3);
            
            for (let i = 0; i < count; i++) {
              const category = categories.nth(i);
              const text = await category.textContent();
              await category.click();
              await page.waitForTimeout(300);
              console.log(`‚úÖ "${text}" ÌÅ¥Î¶≠ ÏôÑÎ£å`);
            }
          });
        
          test('Îâ¥Ïä§ ÏÜåÏä§ ÎìúÎ°≠Îã§Ïö¥', async ({ page }) => {
            const dropdown = page.locator('.source-dropdown');
            if (await dropdown.count() > 0) {
              await dropdown.click();
              await page.waitForTimeout(200);
              
              const items = page.locator('.dropdown-item');
              const itemCount = await items.count();
              
              if (itemCount > 0) {
                await items.first().click();
                await page.waitForTimeout(300);
                console.log(`‚úÖ ÏÜåÏä§ ÏÑ†ÌÉù ÏôÑÎ£å`);
              }
            }
          });
        
          test('ÎÇ†Ïßú ÏÑ†ÌÉùÍ∏∞', async ({ page }) => {
            // Î®ºÏ†Ä Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÅ¥Î¶≠ÌïòÏó¨ news-section ÌëúÏãú
            const categories = page.locator('li.category-item');
            if (await categories.count() > 0) {
              await categories.first().click();
              await page.waitForTimeout(500);
            }

            // Ïù¥Ï†ú ÎÇ†Ïßú ÏÑ†ÌÉùÍ∏∞ ÏÇ¨Ïö©
            const datePicker = page.locator('input[type="date"]');
            if (await datePicker.count() > 0) {
              await expect(datePicker).toBeVisible();
              await datePicker.fill('2025-12-02');
              await page.waitForTimeout(500);
              console.log('‚úÖ ÎÇ†Ïßú ÏÑ†ÌÉù ÏôÑÎ£å');
            }
          });
        
          test('JavaScript ÏóêÎü¨ ÏóÜÏùå', async ({ page }) => {
            const errors: string[] = [];
            page.on('pageerror', err => errors.push(err.message));
            
            const categories = page.locator('li.category-item');
            if (await categories.count() > 0) {
              await categories.first().click();
              await page.waitForTimeout(500);
            }
            
            expect(errors).toHaveLength(0);
            console.log('‚úÖ JavaScript ÏóêÎü¨ ÏóÜÏùå');
          });
        });
        EOF
    
    - name: Run Playwright tests
      run: npx playwright test --reporter=list
    
    - name: Upload Playwright report
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7
    
    - name: Stop HTTP server
      if: always()
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          kill $SERVER_PID 2>/dev/null || true
        fi
    
    - name: Summary
      if: success()
      run: |
        echo "================================"
        echo "‚úÖ All tests passed successfully!"
        echo "================================"
        echo ""
        echo "Tested components:"
        echo "  ‚úÖ HTML structure"
        echo "  ‚úÖ JavaScript functions (8Í∞ú)"
        echo "  ‚úÖ CSS files"
        echo "  ‚úÖ Image assets"
        echo "  ‚úÖ JSON data format (Îâ¥Ïä§ + Ìä∏Î†åÎìú)"
        echo "  ‚úÖ HTTP server"
        echo "  ‚úÖ Internal links"
        echo "  ‚úÖ E2E: Menu navigation"
        echo "  ‚úÖ E2E: Category switching"
        echo "  ‚úÖ E2E: Trend button"
        echo "  ‚úÖ E2E: JavaScript execution"
        echo ""
        echo "Website is ready for deployment! üöÄ"
